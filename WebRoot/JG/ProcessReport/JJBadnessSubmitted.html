<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>不良报工-非扫码-精工云MES系统移动端</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link href="/JG/Content/jquery/weui/style/weui.min.css" rel="stylesheet"/>
    <link href="/JG/Content/jquery/jquery-weui/css/jquery-weui.min.css" rel="stylesheet"/>
    <link href="/JG/Content/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="/JG/Content/css/bootstrap-select.min.css" rel="stylesheet"/>
    <link href="/JG/Content/css/Global.css" rel="stylesheet"/>
    <link rel="stylesheet" href="/JG/Content/css/JJBadnessSubmitted.css">
    <script src="/JG/Content/LocalConfigs.js?v=1"></script>
    <script src="/JG/Content/LocalUserInfo.js"></script>
    <style>
        [v-cloak] {
            display: none;
        }
    </style>
</head>

<body>
<header class="header">
    <div class="empty">
        <span id="stations"></span>
    </div>
    <div class="header_title">
        <a href="javascript:;">物料不良报工</a>
    </div>
    <div class="item item2">
        <div class="user_img" onclick="javascript:location.href='/JG/Features/Infrared.html'">
            <span class="back"><img src="/JG/Content/images/return.png" alt=""></span>
        </div>
    </div>
</header>

<div id="MainPage" v-cloak>
    <div class="top_modal">
        <div class="left_list">
            <!--            <div class="pro_line weui-cell weui-cell_select weui-cell_select-after">-->
            <!--                <div class="weui-cell__hd">-->
            <!--                    <label class="weui-label">生产线</label>-->
            <!--                </div>-->
            <!--                <div class="weui-cell__bd">-->
            <!--                    <select class="weui-select" name="select2" v-model="FormData.ProductionLineCode"-->
            <!--                            placeholder="请选择生产线" v-on:change="ProLineClick(this)">-->
            <!--                        <option disabled selected value>请选择生产线</option>-->
            <!--                        <option v-for="(item,index) in ProLineData" v-bind:value="item.CXSJ_CXBM">-->
            <!--                            {{item.CXSJ_CXMC}}-->
            <!--                        </option>-->
            <!--                    </select>-->
            <!--                </div>-->
            <!--            </div>-->
            <!--            <div class="pro_line">-->
            <!--                <span>任务单号</span>-->
            <!--                <span class="product_name">-->
            <!--                        <input class="input_value" v-bind:value="FormData.TaskCode" type="text" readonly="readonly"-->
            <!--                               placeholder="请选择该产线任务订单">-->
            <!--                        <i class="icon-img"></i>-->
            <!--                    </span>-->
            <!--            </div>-->
            <div class="pro_line">
                <span>MO:</span>
                <span class="product_name">
                        <input class="input_value" v-bind:value="FormData.SCDH" type="text" readonly="readonly"
                               placeholder="请选择该产线的MO单号">
                        <i class="icon-img"></i>
                    </span>
            </div>
            <div class="pro_line">
                <span>订单号码:</span><span>{{FormData.OrderCode}}</span>
            </div>
            <!--            <div class="pro_line weui-cell weui-cell_select weui-cell_select-after">-->
            <!--                <div class="weui-cell__hd">-->
            <!--                    <label for="gongxu_sel" class="weui-label">物料</label>-->
            <!--                </div>-->
            <!--                <div class="weui-cell__bd">-->
            <!--                    <select id="gongxu_sel" v-on:change="changeWL" v-model="FormData.WLBH"-->
            <!--                            class="weui-select" name="select2" placeholder="请选择物料">-->
            <!--                        <option disabled selected value>请选择物料</option>-->
            <!--                        <option v-for="(item,index) in WLData" v-bind:value="item.GDWLB_WLBM">-->
            <!--                            {{item.GDWLB_WLMC}}-->
            <!--                            &lt;!&ndash;                            //GDWLB_WLMC&ndash;&gt;-->
            <!--                        </option>-->
            <!--                    </select>-->
            <!--                </div>-->
            <!--            </div>-->
        </div>
        <div class="right_list">
            <div class="pro_line">
                <span style="width: 35%;">产品编号/产品名称</span>
                <span style="width: 45%;">
<!--                        <i class="icon-img"></i>-->
                        {{FormData.ProCode}}/{{FormData.InvName}}
                    </span>
            </div>
            <!--            <div class="pro_line">-->
            <!--                <span>产品编号</span>-->
            <!--                <span class="product_name">-->
            <!--                        <i class="icon-img"></i>-->
            <!--                        <input class="input_value" v-bind:value="FormData.ProCode" type="text" readonly="readonly"-->
            <!--                               placeholder="请选择该产线生产产品">-->
            <!--                    </span>-->
            <!--            </div>-->
            <!--            <div class="pro_line">-->
            <!--                <span>MO:</span><span>{{FormData.SCDH}}</span>-->
            <!--            </div>-->
            <div class="pro_line">
                <span>计划数量:</span><span>{{FormData.jhsl}}</span>
            </div>
            <!--            <div class="pro_line weui-cell weui-cell_select weui-cell_select-after">-->
            <!--                <div class="weui-cell__hd">-->
            <!--                    <label for="gongwei_sel" class="weui-label">生产工位</label>-->
            <!--                </div>-->
            <!--                <div class="weui-cell__bd">-->
            <!--                    <select id="gongwei_sel" v-on:change="StationClick(this)" v-model="FormData.StationCode"-->
            <!--                            class="weui-select" name="select2" placeholder="请选择工位">-->
            <!--                        <option disabled selected value>请选择工位</option>-->
            <!--                        <option v-for="(item,index) in StationData" v-bind:value="item.GW_GWBH">-->
            <!--                            {{item.GW_GWMC}}-->
            <!--                        </option>-->
            <!--                    </select>-->
            <!--                </div>-->
            <!--            </div>-->
            <!--            <div class="pro_line">-->
            <!--                <span>生产产品</span>-->
            <!--                <span class="product_name">-->
            <!--                        <i class="icon-img"></i>-->
            <!--                        <input class="input_value" v-bind:value="FormData.InvName" type="text" readonly="readonly"-->
            <!--                               placeholder="请选择该产线生产产品">-->
            <!--                    </span>-->
            <!--            </div>-->


        </div>
        <!--清除浮动-->
        <div class="clean"></div>
    </div>

    <div class="bad_modal">
        <div class="left_list">
            <div class="bad_list">
                <div class="bad_ul">
                    <ul class="title_ul" style="list-style: none;margin-bottom: 0px !important;">
                        <li>物料列表</li>
                        <li class="wl_title">
                            <span>类别</span>
                            <span>物料编码</span>
                            <span>物料名称</span>
                        </li>
                    </ul>
                    <ul class="content" style="overflow-y: auto;">
                        <li class="in_title" v-for="(item,index) in WLData" @click="clickChangeWL(item)" :id="item.JGMES_PLAN_GDWLB_ID">
                            <span>{{item.GDWLB_WLLB}}</span>
                            <span>{{item.GDWLB_WLJBM}}</span>
                            <span>{{item.GDWLB_WLMC}}</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <!--不良项部分-->
        <div class="right_list">
            <div class="bad_list">
                <div class="bad_ul">
                    <ul class="title_ul" style="list-style: none;">
                        <li>不良项</li>
                        <li class="bad_title">
                            <span>不良项名称</span>
                            <span>不良项数量</span>
                        </li>
                    </ul>
                    <ul>
                        <li class="bad_li" v-for="(item,index) in DefectiveItemData" @click="toggle(item)" :key="index">
                            <span class="bad_span" style="display:none">
                                <img :src="check(item)?'/JG/Content/images/none.png':'/JG/Content/images/none2.png'"
                                     alt="">
                            </span>
                            <span>{{item.BadName}}</span>
                            <div class="bad_span">
                                <span>
                                    <button @click.stop class="dys_btn" type="button" :disabled="item.Qty==0"
                                            @click="BadItemFun(item)">-</button>
                                    <span class="bad_input">
                                        <input :id="item.ItemID" type="text" placeholder="请输入不良项数量" v-model="item.Qty"
                                               @click.stop>
                                    </span>
                                    <button @click.stop class="dys_btn" type="button"
                                            @click="BadItemFun2(item)">+</button>
                                </span>
                            </div>
                        </li>
                    </ul>
                    <!--                <ul>-->
                    <!--                    <li class="bad_li" v-for="(item,index) in DefectiveItemData" @click="toggle(item)" :key="index">-->
                    <!--                            <span class="bad_span">-->
                    <!--                                <img :src="check(item)?'/JG/Content/images/none.png':'/JG/Content/images/none2.png'"-->
                    <!--                                     alt="">-->
                    <!--                            </span>-->
                    <!--                        <span>{{item.BLLX_BLLXMC}}</span>-->
                    <!--                        <div class="bad_span">-->
                    <!--                                <span>-->
                    <!--                                    <button @click.stop class="dys_btn" type="button" :disabled="item.Qty==0"-->
                    <!--                                             @click="BadItemFun(item)">-</button>-->
                    <!--                                    <span class="bad_input">-->
                    <!--                                        <input :id="item.JGMES_BASE_BLLX_ID" type="text" placeholder="请输入不良项数量" v-model="item.Qty">-->
                    <!--                                    </span>-->
                    <!--                                    <button @click.stop class="dys_btn" type="button"-->
                    <!--                                             @click="BadItemFun2(item)">+</button>-->
                    <!--                                </span>-->
                    <!--                        </div>-->
                    <!--                    </li>-->
                    <!--                </ul>-->
                </div>
            </div>
            <!--提交按钮-->
            <div class="sub_btn">
                <button type="button" class="btn btn-success" v-on:click="SubmitBadItem">提交</button>
            </div>
        </div>
    </div>

    <!--任务列表弹窗选项部分-->
    <div tabindex="-1" class="modal fade in" id="myModal" role="dialog" aria-hidden="true"
         aria-labelledby="myModalLabel">
        <div class="modal-dialog bad_dialog">
            <div class="modal-content">
                <!--头部-->
                <div class="modal-header bad_header">
                    <div>
                        <button class="close" aria-hidden="true" type="button" data-dismiss="modal">×</button>
                        <h4 class="modal-title" id="myModalLabel">生产任务列表</h4>
                    </div>
                    <div class="task_btn row">
                        <div class="search_list col-lg-12 col-md-12 col-sm-12" style="text-align: left">
                            <div class="search_item">
                                <span>单据信息</span>
                                <input v-model="FormData.ProTaskCode" id="ProTaskCode" type="text"
                                       placeholder="工单/订单/任务单号">
                            </div>
                            <div class="search_item">
                                <span>产品信息</span>
                                <input v-model="FormData.KeyWord" id="KeyWord" type="text"
                                       placeholder="产品编号/产品名称/型号">
                            </div>
                            <div class="search_item">
                                <span>任务状态</span>
                                <div class="state_div" style="height:44px;display: inline-block;">
                                    <select id="TaskStateData" class="selectpicker" multiple="multiple"
                                            v-model="FormData.TaskState" style="background-color: #FFFFFF">
                                        <option v-for="(item,index) in TaskStateData"
                                                :value="item.DICTIONARYITEM_ITEMCODE">
                                            {{item.DICTIONARYITEM_ITEMNAME}}
                                        </option>
                                    </select>
                                </div>
                            </div>
                            <div class="shut_btn">
                                <button class="btn btn-success" v-on:click="SearchData">搜索</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!--内容部分-->
                <div class="modal-body bad_body" id="tanchu" style="overflow-x: auto;overflow-y: auto;">
                    <div class="bs-example" data-example-id="hoverable-table">
                        <table class="table table-hover" id="btable">
                            <thead>
                            <tr class="row">
                                <!--<th class="col-lg-3 col-md-3 col-sm-3 col-xs-3">任务单号</th>-->
                                <th>选择</th>
                                <th>日期</th>
                                <th>产品编码/名称/型号</th>
                                <th>工单/订单/任务单号</th>
                                <th>生产单号（MO)</th>
                                <th>生产状态</th>
                                <th>订单数</th>
                                <th>任务/完成数量</th>
                            </tr>
                            </thead>
                            <tbody id="tableble" class="task_tbody">
                            <tr class="row" v-for="(item,index) in TaskCodeGat"
                                v-if="FormData.ScrwAllCount > 0">
                                <!--<td class="col-lg-3 col-md-3 col-sm-3 col-xs-3">{{item.TaskCode}}</td>-->
                                <td class="col-lg-1 col-md-1 col-sm-1 col-xs-1">
                                    <input class="radio_input" type="button" name="inputs" value="选择"
                                           v-on:click="SubData(item)"/>
                                </td>
                                <td class="col-lg-2 col-md-2 col-sm-2 col-xs-2">{{item.SCRW_PCRQ}}</td>
                                <td class="col-lg-3 col-md-3 col-sm-3 col-xs-3">
                                    {{item.SCRW_CPBH}}</br>{{item.SCRW_NAME}}</br>{{item.SCRW_CPGG}}
                                </td>
                                <td class="col-lg-3 col-md-3 col-sm-3 col-xs-3">
                                    {{item.SCRW_GDHM}}</br>{{item.SCRW_DDHM}}</br>{{item.SCRW_RWDH}}
                                </td>
                                <td class="col-lg-1 col-md-1 col-sm-1 col-xs-1">{{item.SCRW_SCDH}}</td>
                                <td class="col-lg-1 col-md-1 col-sm-1 col-xs-1">{{item.SCRW_RWZT_NAME}}</td>
                                <td class="col-lg-1 col-md-1 col-sm-1 col-xs-1">{{item.SCRW_DDSL}}</td>
                                <td class="col-lg-1 col-md-1 col-sm-1 col-xs-1">
                                    {{item.SCRW_PCSL}}/{{item.SCRW_WCSL}}
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <!--底部分页部分-->
                <div class="modal-footer page_footer">
                    <div class="page_num">
                        <button type="button" class="btn btn-success prev" :disabled="FormData.ScrwCurrPage==1"
                                @click="PrevFunction">上一页
                        </button>
                        <span>第{{FormData.ScrwCurrPage}}页/总{{FormData.ScrwTotalCountPages}}页
                                每页{{FormData.ScrwPageSize}}条 总{{FormData.ScrwAllCount}}条</span>
                        <button type="button" class="btn btn-success next"
                                :disabled="FormData.ScrwCurrPage==FormData.ScrwTotalCountPages"
                                @click="NextFunction">下一页
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<script src="/JG/Content/jquery/jquery-3.2.1.min.js"></script>
<script src="/JG/Content/bootstrap.min.js"></script>
<script src="/JG/Content/bootstrap-select.min.js"></script>
<script src="/JG/Content/jquery/jquery-weui/js/jquery-weui.min.js"></script>
<script src="/JG/Content/Utils.js?v=1"></script>
<script src="/JG/Content/vue-v2.34.js"></script>
<script src="/JG/Content/Common.js"></script>
<script src="/JG/Content/Numkeyboard.js"></script>
<script src="/JG/Content/bootstrap/bootbox/bootbox.min.js"></script>
<script src="/JG/Content/bootstrap/bootbox/bootbox.locales.min.js"></script>

<script type="text/javascript">
    //body赋值滚动条
    window.onload = function () {
        var BodyWidth = $(window).width();
        var BodyHeight = $(window).height();
        var ContentHeight =  BodyHeight*(7/10) -100;
        $(".content").height(ContentHeight);

        if (BodyWidth > 1280) {
            //给Main的div加垂直滚动条
            var MainPageHeight = BodyHeight - 90;
            $("#MainPage").height(MainPageHeight);

            //任务列表弹窗
            var ModalBodyHeight = BodyHeight - 108 - 60;
            $("#tanchu").height(ModalBodyHeight);

        } else if (BodyWidth < 1281 && BodyWidth > 1023) {
            var MainPageHeight = BodyHeight - 90;
            $("#MainPage").height(MainPageHeight);

            //任务列表弹窗
            var ModalBodyHeight = BodyHeight - 108 - 60;
            $("#tanchu").height(ModalBodyHeight);

        } else if (BodyWidth < 1024 && BodyWidth > 767) {
            var MainPageHeight = BodyHeight - 90;
            $("#MainPage").height(MainPageHeight);

            //任务列表弹窗
            var ModalBodyHeight = BodyHeight - 135 - 60;
            $("#tanchu").height(ModalBodyHeight);

        } else {
            var MainPageHeight = BodyHeight - 70;
            $("#MainPage").height(MainPageHeight);

            //任务列表弹窗
            var ModalBodyHeight = BodyHeight - 206 - 60;
            $("#tanchu").height(ModalBodyHeight);
        }
    }

</script>
<script type="text/javascript">
    // $("ul.content>li").each(function (index) {
    //     $(this).on("click",function () {
    //         console.log(111)
    //         $("ul.content>li").eq(index).addClass("active").siblings("ul.content>li").removeClass("active")
    //
    //     })
    // })
</script>
<script type="text/javascript">
    var vmPage = new Vue({
        el: "#MainPage",
        data: {
            Qty: 0,   //不良数量
            spreadData: "",//跳转传值
            FormData: {
                ProductionLineCode: "", //生产线编码
                StationCode: "",  //工位
                GylxgsGxnum: "",//工序编号
                ScrwID: "",    //生产任务ID
                ProCode: "",     //产品编码
                InvName: "",   //产品名称
                ProdLine: "",   //产线名称
                // ProductStd:"",   //产品型号
                InvStd: "",   //工位名
                WordCode: "",   //工单号
                OrderCode: "",    //订单号
                TaskCode: "",     //任务单号
                SCDH: "",//生产单号
                process: "",    //当前选中工序名称
                GxID: "",   //当前选中工序ID
                OrderNum: "",    //当前任务单的订单数量
                TaskQty: "",     //任务数量
                SubType: "1",    //报工类型
                ProTaskCode: "",     //获取当前用户输入任务单号或订单号
                KeyWord: "",         //获取当前用户输入产品关键字
                TaskState: [],      //生产任务状态
                Moid: "",//另一个系统的参数，从生产任务单中读取
                ScrwAllCount: "",    //请求到前端的全部条数
                ScrwPageSize: 10,    //每页条数
                ScrwTotalCountPages: "",    //总页数
                ScrwCurrPage: 1,     //当前页
                WLBH: "",//不良物料编号
                WLMC: "",//不良物料名称
                gdwlID: "",//工单物料表主键ID
                jhsl: 0.
            },
            ProLineData: [],   //产线集合
            StationData: [],    //工位集合
            //WorkCodeData:[],   //工单号集合
            TaskCodeGat: [],  //生产任务信息
            ProcessData: [],   //工序集合
            DefectiveItemBindData: [],   //不良项集合拷贝
            DefectiveItemData: [],     //不良项集合
            BadData: [],       //不良报工记录集合
            badItemData: [],   //选中当前不良项集合
            TaskStateData: [],     //生产任务状态集合
            JudgeScrwID: "",//提交时判断产品任务ID和扫的任务ID是否一致
            WLData: [],//不良物料集合

        },
        mounted: function () {        //html挂载后触发
            var currSelf = this;
            var spData = sessionStorage.getItem("itemJson");
            if (spData != null && spData != "" && spData != undefined) {
                currSelf.spreadData = JSON.parse(sessionStorage.getItem("itemJson"));
            }
            var DefectiveItemJson = JSON.stringify([]);//初始化不良集合
            sessionStorage.setItem("DefectiveItemJson", DefectiveItemJson);
            currSelf.ProLineStation();
            currSelf.ProdLineMethod();
            $("#TaskCode").bind("keypress", currSelf.GetTaskCodeInfo)
            $("#TaskCode").focus();
        },

        methods: {
            //获取产线
            ProLineStation: function () {
                var currSelf = this;
                //获取产线和工位接口
                $.showLoading();
                $.ajax({
                    type: "post",
                    async: false,   //异步
                    url: LocalConfig.SrvPath + "/jgmes/commonAction!getCxGwList.action",
                    //url: LocalConfig.SrvPath + "/jgmes/commonAction!getCxGwListFilterOutNoScrw.action",
                    data: {},
                    dataType: "json",
                    success: function (result) {
                        var retData = ReturnData(result);
                        if (retData.IsSuccess) {
                            if (retData.Data) {
                                currSelf.ProLineData = retData.Data;
                                if (currSelf.spreadData != null && currSelf.spreadData != "" && currSelf.spreadData != undefined) {//传值不为空时
                                    console.log(currSelf.spreadData);
                                    currSelf.FormData.ProductionLineCode = currSelf.spreadData.SCRW_CXBM;//产线编码
                                    currSelf.FormData.ProdLine = currSelf.spreadData.SCRW_CXMC;//产线名称
                                    currSelf.FormData.TaskCode = currSelf.spreadData.SCRW_RWDH;//任务单号
                                    currSelf.FormData.ProCode = currSelf.spreadData.SCRW_CPBH;//产品编号
                                    currSelf.FormData.InvName = currSelf.spreadData.SCRW_NAME;//产品名称
                                    currSelf.FormData.Moid = currSelf.spreadData.SCRW_MOID;//产品名称
                                    currSelf.FormData.jhsl = currSelf.spreadData.SCRW_PCSL;//排产数量（计划数量）
                                    currSelf.FormData.SCDH = currSelf.spreadData.SCRW_SCDH;//生产单号
                                    currSelf.FormData.OrderCode = currSelf.spreadData.SCRW_DDHM;//订单号
                                    // sessionStorage.setItem("itemJson","");//清空传入数据
                                    currSelf.getGdWlByMoID();
                                }
                            }
                        } else if (!retData.Data) {
                            var showMsg = "未能找到该产线与工位信息";
                            $.toptip(showMsg, "warning");
                        }
                    },
                    error: function (xhr, status, errorThrow) {
                        console.error(status);
                        $.alert("获取产线，工位失败!");
                    },
                    complete: function () {
                        $.hideLoading();
                    },
                });


            },

            //获取当前选中的工位方法
            StationClick: function () {
                var currSelf = this;
                $.each(currSelf.StationData, function (index, item) {
                    if (currSelf.FormData.InvCode == item.GW_GWBH) {
                        currSelf.FormData.InvCode = item.GW_GWBH;
                        currSelf.FormData.InvStd = item.GW_GWMC;
                    }
                });
            },
            //选择当前产线带出相对应的工位方法
            ProLineClick: function () {
                var currSelf = this;
                currSelf.StationData = [];
                currSelf.DefectiveItemData = [];
                //currSelf.DefectiveItemBindData = [];    //清空之前选中工序对应的不良项
                currSelf.badItemData = [];   //清空之前选中的不良项
                currSelf.FormData.StationCode = "";  //工位
                currSelf.FormData.GylxgsGxnum = "";//工序
                currSelf.FormData.ScrwID = "";    //生产任务ID
                currSelf.FormData.ProCode = "";     //产品编码
                currSelf.FormData.InvName = "";   //产品名称
                currSelf.FormData.ProdLine = "";   //产线名称
                currSelf.FormData.InvStd = "";   //工位名
                currSelf.FormData.WordCode = "";   //工单号
                currSelf.FormData.OrderCode = "";   //订单号
                currSelf.FormData.TaskCode = "";   //任务单号
                currSelf.FormData.OrderCode = ""//订单号
                currSelf.FormData.SCDH = "";      //生产单号
                currSelf.FormData.process = "";    //当前选中工序名称
                currSelf.FormData.GxID = "";   //当前选中工序ID
                currSelf.FormData.OrderNum = "";    //当前任务单的订单数量
                currSelf.FormData.TaskQty = "";
                currSelf.FormData.SubType = "1";    //报工类型
                currSelf.FormData.WLBH = "";//不良物料编号
                currSelf.FormData.WLMC = "";//不良物料名称
                currSelf.FormData.gdwlID = "";//工单物料表主键ID
                currSelf.WLData = [],//不良物料集合
                    $.each(currSelf.ProLineData, function (index, item) {
                        if (currSelf.FormData.ProductionLineCode == item.CXSJ_CXBM) {
                            currSelf.ProLineData.ProdLine = item.CXSJ_CXMC;
                            currSelf.StationData = item.detail;
                        }
                    });
                //获取当前生产线生产中的任务单号
                $.ajax({
                    type: "post",
                    url: LocalConfig.SrvPath + "/jgmes/commonAction!getScrw.action",
                    async: false,   //同步
                    data: {
                        "userCode": LocalUserInfo.GetUserInfo().UserCode,
                        "mac": LocalUserInfo.GetUserInfo().Mac,
                        "cxCode": currSelf.FormData.ProductionLineCode,
                        "zt": "RWZT02",

                    },
                    dataType: "json",
                    success: function (ret) {
                        var retData = ReturnData(ret);
                        if (retData.IsSuccess) {
                            if (retData.Data.length > 0) {
                                currSelf.FormData.WordCode = retData.Data[0].SCRW_GDHM;   //给页面工单号赋值
                                currSelf.FormData.OrderCode = retData.Data[0].SCRW_DDHM;   //给页面订单号赋值
                                currSelf.FormData.TaskCode = retData.Data[0].SCRW_RWDH;   //给页面工任务单号赋值
                                currSelf.FormData.SCDH = retData.Data[0].SCRW_SCDH;      //生产单号
                                currSelf.FormData.InvName = retData.Data[0].SCRW_NAME;    //给页面产品名称赋值
                                currSelf.FormData.ProCode = retData.Data[0].SCRW_CPBH;    //选中当前的产品编号
                                currSelf.FormData.OrderNum = retData.Data[0].SCRW_DDSL;
                                currSelf.FormData.TaskQty = retData.Data[0].SCRW_PCSL;
                                currSelf.FormData.ScrwID = retData.Data[0].JGMES_PLAN_SCRW_ID;    //生产任务ID
                                currSelf.FormData.Moid = retData.Data[0].SCRW_MOID;
                                currSelf.FormData.OrderCode = retData.Data[0].SCRW_DDHM;//订单号
                                currSelf.getGdWlByMoID();
                            } else {
                                var meg = "该产线下没有生产中的任务!";
                                $.toptip(meg, "warning");
                            }
                        }
                    },
                    error: function (xhr, status, errorThrown) {
                        $.alert("请求失败！" + errorThrown);
                    },
                    complete: function () {
                        $.hideLoading();
                    }
                });


            },

            //获取产线全部信息方法
            ProdLineMethod: function () {
                var currSelf = this;
                //请求数据字典中的状态数据
                var data = GetDictionary("JGMES_DIC_RWZT");
                if (data && data.IsSuccess) {
                    currSelf.TaskStateData = data.Data;
                    currSelf.FormData.TaskState.push("RWZT01");
                    currSelf.FormData.TaskState.push("RWZT02");
                }

                var msg;
                $(".input_value,.icon-img").click(function () {
                    if (!currSelf.FormData.ProductionLineCode) {
                        msg = "请先选择生产线!";
                        $.toptip(msg, "warning");
                    } else {
                        $("#myModal").modal("show");
                        //清空原有加载数据
                        currSelf.TaskCodeGat = [];
                        if (currSelf.FormData.TaskState && currSelf.FormData.TaskState.length > 0) {
                            currSelf.SearchLine();
                        } else {
                            $.toptip("请先选择任务状态关键字!", "warning");
                        }
                    }
                });
            },

            //点击弹窗选择按钮方法
            SubData: function (val) {
                var currSelf = this;
                //currSelf.ProcessData=[];    //工序集合
                //清空数据
                currSelf.DefectiveItemData = [];  //清空之前选中工序对应的不良项集合
                currSelf.FormData.WordCode = "";
                currSelf.FormData.OrderCode = "";
                currSelf.FormData.TaskCode = "";
                currSelf.FormData.SCDH = "";
                currSelf.FormData.InvName = "";
                currSelf.FormData.ProCode = "";
                currSelf.FormData.OrderNum = "";
                currSelf.FormData.TaskQty = "";
                currSelf.FormData.ScrwID = "";
                currSelf.FormData.WLBH = "";//不良物料编号
                currSelf.FormData.WLMC = "";//不良物料名称
                currSelf.FormData.gdwlID = "";//工单物料表主键ID
                currSelf.WLData = [];//不良物料集合
                currSelf.FormData.OrderCode = "";//订单号

                //currSelf.DefectiveItemBindData = [];     //清空之前选中工序对应的不良项集合

                $("#myModal").modal("hide");
                currSelf.FormData.WordCode = val.SCRW_GDHM;   //给页面工单号赋值
                currSelf.FormData.OrderCode = val.SCRW_DDHM;   //给页面订单号赋值
                currSelf.FormData.TaskCode = val.SCRW_RWDH;   //给页面工任务单号赋值
                currSelf.FormData.SCDH = val.SCRW_SCDH;         //生产单号
                currSelf.FormData.InvName = val.SCRW_NAME;    //给页面产品名称赋值
                currSelf.FormData.ProCode = val.SCRW_CPBH;    //选中当前的产品编号
                currSelf.FormData.OrderNum = val.SCRW_DDSL;
                currSelf.FormData.TaskQty = val.SCRW_PCSL;
                currSelf.FormData.ScrwID = val.JGMES_PLAN_SCRW_ID;    //生产任务ID
                currSelf.FormData.Moid = val.SCRW_MOID;
                currSelf.FormData.OrderCode = val.SCRW_DDHM;//订单号
                currSelf.getGdWlByMoID();


                // //根据产品获取工序列表接口
                // $.showLoading();
                // $.ajax({
                //     type: "post",
                //     url: LocalConfig.SrvPath + "/jgmes/commonAction!getGXListByCpBh.action",
                //     data: {
                //         "userCode": LocalUserInfo.GetUserInfo().UserCode,
                //         "mac": LocalUserInfo.GetUserInfo().Mac,
                //         "cpCode": val.SCRW_CPBH,   //产品编号
                //         "zt": "RWZT01,RWZT02,RWZT04",
                //     },
                //     dataType: "json",
                //     success: function (ret) {
                //         var retData = ReturnData(ret);
                //         //console.log(retData);
                //         if (retData.IsSuccess) {
                //             if (retData.Data) {
                //                 currSelf.ProcessData = retData.Data;
                //             } else {
                //                 var meg = "没有相关不良项的工序!";
                //                 $.toptip(meg, "warning");
                //             }
                //         }
                //     },
                //     error: function (xhr, status, errorThrown) {
                //         $.alert("请求失败！" + errorThrown);
                //     },
                //     complete: function () {
                //         $.hideLoading();
                //     }
                // });
            },
            //不良物料改变时触发方法
            changeWL: function () {
                var currSelf = this;
                $.each(currSelf.WLData, function (index, item) {
                    if (currSelf.FormData.WLBH == item.GDWLB_WLBM) {
                        currSelf.FormData.WLMC = item.GDWLB_WLMC;
                        currSelf.FormData.WLBH = item.GDWLB_WLBM;
                        currSelf.FormData.gdwlID = item.JGMES_PLAN_GDWLB_ID;
                    }
                });
                //获取物料不良项
                $.ajax({
                    type: "post",
                    url: LocalConfig.SrvPath + "/jgmes/jgmesQmsAction!getWlBlList.action",
                    data: {
                        "userCode": LocalUserInfo.GetUserInfo().UserCode,
                        "mac": LocalUserInfo.GetUserInfo().Mac,
                        "gdwlID": currSelf.FormData.gdwlID,
                    },
                    dataType: "json",
                    success: function (ret) {
                        var retData = ReturnData(ret);
                        //console.log(retData);
                        // if (retData.IsSuccess) {
                        //     if (retData.Data) {
                        //
                        //
                        //         currSelf.DefectiveItemData = retData.Data;
                        //         //初始化不良项
                        //         for (var i = 0;i<currSelf.DefectiveItemData.length;i++){
                        //             currSelf.DefectiveItemData[i].Qty="";
                        //         }
                        //         currSelf.DefectiveItemBindData = JSON.parse(JSON.stringify(currSelf.DefectiveItemData));    //将
                        //         //不良项数量部分的数字键盘绑定
                        //         currSelf.$nextTick(function () {     //$nextTick方法是进行获取数据后，对更新后的hmtl做操作
                        //             $.each(currSelf.DefectiveItemData, function (i, item) {
                        //                 $("#" + item.JGMES_BASE_BLLX_ID).mynumkb();
                        //             });
                        //         });
                        //     }
                        if (retData.Data) {
                            for (var i in retData.Data) {
                                var element = retData.Data[i];
                                currSelf.DefectiveItemData.push({
                                    BadName: element.BLLX_BLLXMC,   //不良名称
                                    ItemID: element.BLLX_BLLXBM,
                                    Qty: "",

                                });
                            }
                            currSelf.DefectiveItemBindData = JSON.parse(JSON.stringify(currSelf.DefectiveItemData));    //将
                            //不良项数量部分的数字键盘绑定
                            currSelf.$nextTick(function () {     //$nextTick方法是进行获取数据后，对更新后的hmtl做操作
                                $.each(currSelf.DefectiveItemData, function (i, item) {
                                    $("#" + item.ItemID).mynumkb();
                                });
                            });
                        } else {
                            var meg = "没有物料不良项";
                            $.toptip(meg, "warning");
                        }
                    },
                    error: function (xhr, status, errorThrown) {
                        $.alert("请求失败！" + errorThrown);
                    },
                    complete: function () {
                        $.hideLoading();
                    }
                });

            },

            //左边部分点击获取右边部分的不良项，ljs
            //不良物料改变时触发方法
            clickChangeWL: function (itemData) {
                var currSelf = this;
                var child = $("#"+itemData.JGMES_PLAN_GDWLB_ID).parent().children();
                for (var i=0;i<child.length;i++){
                    $("#"+child[i].id).removeClass("active");
                }
                $("#"+itemData.JGMES_PLAN_GDWLB_ID).addClass("active");
                //获取当前不良项信息
                var saveData = currSelf.DefectiveItemData;
                //获取物料不良项
                currSelf.DefectiveItemData = [];//清空物料不良项集合
                //读取sessionStorage
                var DefectiveItemData = [];
                for (var i = 0; i < JSON.parse(sessionStorage.getItem('DefectiveItemJson')).length; i++) {
                    DefectiveItemData.push(JSON.parse(sessionStorage.getItem('DefectiveItemJson'))[i]);
                }
                //是否调用ajax
                var boolean = true;
                //把之前不良项添加到DefectiveItemData中
                if (saveData.length>0){
                    for (var i = 0; i < DefectiveItemData.length; i++) {
                        if (DefectiveItemData[i][0].gdwlID == saveData[0].gdwlID) {
                            DefectiveItemData.splice(i, 1);
                            DefectiveItemData.push(saveData);
                            break;
                        }
                    }
                }

                //检查需要查询的不良物料是否存在于数据中，有则显示，无则调用ajax添加数据
                for (var i = 0; i < DefectiveItemData.length; i++) {
                    if (DefectiveItemData[i][0].gdwlID == itemData.JGMES_PLAN_GDWLB_ID) {
                        for (var j = 0; j < DefectiveItemData[i].length; j++) {
                            currSelf.DefectiveItemData.push(DefectiveItemData[i][j]);
                        }
                        currSelf.DefectiveItemBindData = JSON.parse(JSON.stringify(currSelf.DefectiveItemData));
                        //不良项数量部分的数字键盘绑定
                        currSelf.$nextTick(function () {     //$nextTick方法是进行获取数据后，对更新后的hmtl做操作
                            $.each(currSelf.DefectiveItemData, function (i, item) {
                                $("#" + item.ItemID).mynumkb();
                            });
                        });
                        boolean = false;
                        break;
                    }
                }
                //调用ajax查询数据
                if (boolean) {
                    $.ajax({
                        type: "post",
                        url: LocalConfig.SrvPath + "/jgmes/jgmesQmsAction!getWlBlList.action",
                        data: {
                            "userCode": LocalUserInfo.GetUserInfo().UserCode,
                            "mac": LocalUserInfo.GetUserInfo().Mac,
                            "gdwlID": itemData.JGMES_PLAN_GDWLB_ID,
                        },
                        dataType: "json",
                        success: function (ret) {
                            var retData = ReturnData(ret);
                            if (retData.Data) {
                                for (var i in retData.Data) {
                                    var element = retData.Data[i];
                                    currSelf.DefectiveItemData.push({
                                        BadName: element.BLLX_BLLXMC,   //不良名称
                                        ItemID: element.BLLX_BLLXBM,
                                        Qty: 0,
                                        gdwlID: itemData.JGMES_PLAN_GDWLB_ID,
                                        wlmc: itemData.GDWLB_WLMC,
                                        wlbm: itemData.GDWLB_WLBM,
                                    });
                                }
                                //储存到sessionStorage
                                DefectiveItemData.push(currSelf.DefectiveItemData);
                                sessionStorage.setItem("DefectiveItemJson", JSON.stringify(DefectiveItemData));
                                currSelf.DefectiveItemBindData = JSON.parse(JSON.stringify(currSelf.DefectiveItemData));
                                //不良项数量部分的数字键盘绑定
                                currSelf.$nextTick(function () {     //$nextTick方法是进行获取数据后，对更新后的hmtl做操作
                                    $.each(currSelf.DefectiveItemData, function (i, item) {
                                        $("#" + item.ItemID).mynumkb();
                                    });
                                });
                            } else {
                                var meg = "没有物料不良项";
                                $.toptip(meg, "warning");
                            }
                        },
                        error: function (xhr, status, errorThrown) {
                            $.alert("请求失败！" + errorThrown);
                        },
                        complete: function () {
                            $.hideLoading();
                        }
                    });
                }
                sessionStorage.setItem("DefectiveItemJson", JSON.stringify(DefectiveItemData));

            },

            saveLastSL: function () {
                var currSelf = this;
                //获取当前不良项信息
                var saveData = currSelf.DefectiveItemData;
                //获取物料不良项
                // currSelf.DefectiveItemData = [];//清空物料不良项集合
                //读取sessionStorage
                var idData = [];
                for (var i = 0; i < JSON.parse(sessionStorage.getItem('DefectiveItemJson')).length; i++) {
                    idData.push(JSON.parse(sessionStorage.getItem('DefectiveItemJson'))[i]);
                }
                //把之前不良项添加到DefectiveItemData中
                for (var i = 0; i < idData.length; i++) {
                    var gdwlID = idData[i][0].gdwlID;
                    if (gdwlID == saveData[0].gdwlID) {
                        idData.splice(i, 1);
                        idData.push(saveData);
                        break;
                    }
                }
                currSelf.DefectiveItemData = saveData;
                sessionStorage.setItem("DefectiveItemJson", JSON.stringify(idData));
            },

            //获取不良物料编码方法
            getGdWlByMoID: function () {
                var currSelf = this;
                //根据mold获取信息
                if (currSelf.FormData.Moid) {
                    $.ajax({
                        type: "post",
                        url: LocalConfig.SrvPath + "/jgmes/jgmesQmsAction!getGdWlByMoID.action",
                        data: {
                            "userCode": LocalUserInfo.GetUserInfo().UserCode,
                            "mac": LocalUserInfo.GetUserInfo().Mac,
                            "moId": currSelf.FormData.Moid,
                        },
                        dataType: "json",
                        success: function (ret) {
                            var retData = ReturnData(ret);
                            //console.log(retData);
                            if (retData.IsSuccess) {
                                if (retData.Data) {
                                    currSelf.WLData = retData.Data;
                                    console.log(currSelf.WLData);
                                } else {
                                    var meg = "没有配置相关的不良物料!";
                                    $.toptip(meg, "warning");
                                }
                            }
                        },
                        error: function (xhr, status, errorThrown) {
                            $.alert("请求失败！" + errorThrown);
                        },
                        complete: function () {
                            $.hideLoading();
                        }
                    });
                } else {
                    var meg = "该任务单没有绑定相关不良物料!";
                    $.toptip(meg, "warning");
                }
            },
            //选中当前不良项方法
            toggle: function (item) {
                var currSelf = this;
                //判断当前选中的集合是否包含有当前选中集合中里的不良项  -1为找不到
                if (currSelf.badItemData.indexOf(item) == -1) {
                    $("#" + item.ItemID).focus();
                    currSelf.badItemData.push(item);   //当没有的时候就push到badItemData集合
                } else {
                    currSelf.badItemData.splice(currSelf.badItemData.indexOf(item), 1);
                }
                // var currSelf = this;
                // //判断当前选中的集合是否包含有当前选中集合中里的不良项  -1为找不到
                // if (currSelf.badItemData.indexOf(item) == -1) {
                //     $("#" + item.JGMES_BASE_BLLX_ID).focus();
                //     currSelf.badItemData.push(item);   //当没有的时候就push到badItemData集合
                // } else {
                //     currSelf.badItemData.splice(currSelf.badItemData.indexOf(item), 1);
                // }
            },

            //判断切换图片
            check: function (item) {
                var currSelf = this;
                return currSelf.badItemData.some(function (num) {
                    return num == item;
                });
            },
            //不良项报工提交方法
            SubmitBadItem: function () {
                var currSelf = this;
                var msg;
                currSelf.saveLastSL();
                //获取不良报工需要保存的信息
                var data = [];
                var saveData = JSON.parse(sessionStorage.getItem('DefectiveItemJson'));
                for (var i = 0; i < saveData.length; i++) {
                    for (var j = 0; j < saveData[i].length; j++) {
                        if (saveData[i][j].Qty != "0" && saveData[i][j].Qty != "") {
                            data.push(saveData[i][j]);
                        }
                    }
                }
                if (data.length == 0) {
                    msg = '请至少填写一个不良项数量';
                    $.toptip(msg, "warning");
                } else if (!currSelf.FormData.SCDH) {
                    // } else if (!currSelf.FormData.TaskCode) {
                    msg = '请先选择MO（生产）单号!';
                    $.toptip(msg, "warning");
                } else {
                    $.confirm("确定对勾选不良项进行报工吗?", "操作提示", function () {
                        // //刷新一下
                        // currSelf.DefectiveItemData=saveData;
                        //不良项子表数据
                        var jsonStrDetail = [];
                        for (var i in data) {
                            var element = data[i];
                            jsonStrDetail.push({
                                "BGSJZB_BLMC": element.BadName,
                                "BGSJZB_BLBH": element.ItemID,
                                "BGSJZB_SL": element.Qty,
                                "BGSJZB_WLBH": element.wlbm,
                                "BGSJZB_WLMC": element.wlmc,
                            });
                        }
                        console.log(jsonStrDetail);
                        var jsonStr = JSON.stringify({
                            "BGSJ_BGLX": currSelf.FormData.SubType,   //报工类型
                            "BGSJ_SCRWID": currSelf.FormData.ScrwID,   //生产任务ID
                            "BGSJ_CXMC": currSelf.ProLineData.ProdLine,   //产线名称
                            "BGSJ_CXBM": currSelf.FormData.ProductionLineCode,   //产线编码
                            "BGSJ_GWMC": currSelf.FormData.InvStd,     //工位名称
                            "BGSJ_GWBH": currSelf.FormData.InvCode,     //工位编号
                            "BGSJ_CPMC": currSelf.FormData.InvName,    //产品名称
                            "BGSJ_CPBH": currSelf.FormData.ProCode,    //产品编号
                            "BGSJ_GXMC": currSelf.FormData.process,    //工序名称
                            "BGSJ_GXBH": currSelf.FormData.GylxgsGxnum,    //工序编号
                            "BGSJ_GWBH": currSelf.FormData.StationCode,
                            "BGSJ_GWMC": currSelf.FormData.InvStd,
                            //"BGSJ_BLSL": TotalQty,     //不良数量
                        });

                        //批量保存数据接口
                        $.showLoading();
                        $.ajax({
                            type: "post",
                            url: LocalConfig.SrvPath + "/jgmes/jgmesBgBatchAction!doJsonSave.action",
                            data: {
                                "userCode": LocalUserInfo.GetUserInfo().UserCode,
                                "jsonStr": jsonStr,
                                "jsonStrDetail": JSON.stringify(jsonStrDetail),
                                "wordcode": currSelf.FormData.WordCode,
                            },
                            dataType: "json",
                            success: function (result) {
                                var retData = ReturnData(result);
                                // var retData = JSON.parse(result);
                                if (retData.IsSuccess) {
                                    $.alert("数据保存成功！");
                                } else {
                                    $.alert("批量保存数据失败！");
                                }
                            },
                            error: function (xhr, status, errorThrow) {
                                //console.error(status);
                                $.alert("批量保存数据失败！" + errorThrow);
                            },
                            complete: function () {
                                $.hideLoading();
                            }
                        });
                    //     //清空之前选中的不良项和输入的不良数量
                    //     currSelf.badItemData = [];
                    //     currSelf.DefectiveItemBindData = JSON.parse(JSON.stringify(currSelf.DefectiveItemData));
                    //     $.each(currSelf.DefectiveItemData, function (index) {
                    //         currSelf.DefectiveItemData[index].Qty = "";
                    //     })
                    });
                }
            }
            ,

            //点击工单列表弹窗搜索按钮方法
            SearchData: function () {
                var currSelf = this;
                currSelf.FormData.ScrwCurrPage = 1;
                currSelf.SearchLine();
            }
            ,
            SearchLine: function () {
                var currSelf = this;

                if (!LocalUserInfo.GetUserInfo().ProductionLineCode) {
                    // bootbox.alert("请先输入需要搜索的内容!");
                    $("#ProTaskCode").focus();  //点击搜索按钮时，搜索框获取聚焦
                    $("#KeyWord").focus();  //点击搜索按钮时，搜索框获取聚焦
                } else if (!currSelf.FormData.TaskState || currSelf.FormData.TaskState.length == 0) {
                    //currSelf.FormData.ScrwCurrPage = 0;
                    currSelf.FormData.ScrwAllCount = 0;
                    currSelf.TaskCodeGat = [];
                    $.toptip("任务状态查询不能为空,请先选择状态!", "warning");
                    $("#TaskStateData").focus();  //点击搜索按钮时，搜索框获取聚焦
                } else {
                    // currSelf.TaskCodeGat=[];
                    $.showLoading();
                    //任务单号接口
                    $.ajax({
                        type: "post",
                        async: true,
                        url: LocalConfig.SrvPath + "/jgmes/commonAction!getScrw.action",
                        data: {
                            "userCode": LocalUserInfo.GetUserInfo().UserCode,
                            "mac": LocalUserInfo.GetUserInfo().Mac,
                            "cxCode": currSelf.FormData.ProductionLineCode,   //产线编码
                            "curDate": currSelf.curDate,    //当前产线的时间
                            "noLike": currSelf.FormData.ProTaskCode,    //获取当前用户输入任务单号
                            "cpLike": currSelf.FormData.KeyWord,     //获取当前用户输入产品关键字
                            "zt": currSelf.FormData.TaskState.join(','),      //任务状态
                            "PageSize": currSelf.FormData.ScrwPageSize,   //每页条数
                            "CurrPage": currSelf.FormData.ScrwCurrPage,     //当前页
                        },
                        dataType: "json",
                        success: function (result) {
                            var ret = ReturnData(result);
                            //console.log(ret);
                            if (ret.IsSuccess) {
                                if (ret.Data.length > 0) {
                                    currSelf.TaskCodeGat = ret.Data;
                                    currSelf.FormData.ScrwAllCount = ret.TotalCount;    //获取当前选择产线的总条数
                                    currSelf.FormData.ScrwTotalCountPages = Math.ceil(currSelf.FormData.ScrwAllCount / currSelf.FormData.ScrwPageSize);   //获取总页数,Math.ceil()函数为向上取整
                                    $(".page_num").addClass("show_page_footer");   //当带点击搜索按钮是请求数据成功便显示分页部分
                                } else {
                                    //$(".page_num").removeClass("show_page_footer");   //当带点击搜索按钮是请求数据成功便隐藏分页部分
                                    //currSelf.FormData.ScrwCurrPage = 0;
                                    currSelf.FormData.ScrwTotalCountPages = 1;
                                    currSelf.FormData.ScrwAllCount = 0;
                                    currSelf.TaskCodeGat = [];    //清空之前搜索的数据
                                    $.toptip("该生产线没有相关任务单信息!", "warning");
                                }
                            }
                        },
                        error: function (xhr, status, errorThrown) {
                            $.alert("搜索相关信息失败!");
                        },
                        complete: function () {
                            $.hideLoading();
                        }
                    });
                }
            }
            ,

            //点击上一页按钮方法
            PrevFunction: function () {
                var currSelf = this;
                currSelf.FormData.ScrwCurrPage--;    //当当前页大于1的时候就减减
                currSelf.SearchLine();
            }
            ,

            //点击下一页按钮方法
            NextFunction: function () {
                var currSelf = this;
                currSelf.FormData.ScrwCurrPage++;    //当当前页小于总页数的时候就加加
                currSelf.SearchLine();
            }
            ,

            //点击不良项部分的减号按钮方法
            BadItemFun: function (item) {
                if (item.Qty > 0) {
                    item.Qty--;
                    // $("#"+item.JGMES_BASE_BLLX_ID).val(item.Qty);
                }
            }
            ,

            //点击不良项部分的加号按钮方法
            BadItemFun2: function (item) {
                item.Qty++;
                // $("#"+item.JGMES_BASE_BLLX_ID).val(item.Qty);
            }
            ,
            GetTaskCodeInfo: function (event) {
                var currSelf = this;
                if (event.which == 13) {
                    // if (currSelf.FormData.ProductionLineCode) {
                    if (currSelf.FormData.TaskCode) {
                        $.showLoading();
                        currSelf.DefectiveItemData = [];  //清空之前选中工序对应的不良项集合
                        currSelf.ProcessData = [];    //工序集合
                        currSelf.FormData.process = "";//清空之前选中的工序
                        //任务单号接口
                        $.ajax({
                            type: "post",
                            async: true,
                            url: LocalConfig.SrvPath + "/jgmes/commonAction!getScrwByRwNo.action",
                            data: {
                                "userCode": LocalUserInfo.GetUserInfo().UserCode,
                                "mac": LocalUserInfo.GetUserInfo().Mac,
                                "rwNo": currSelf.FormData.TaskCode,   //报工任务单号
                            },
                            dataType: "json",
                            success: function (result) {
                                var ret = ReturnData(result);

                                if (ret.IsSuccess) {
                                    for (var element in ret.Data) {
                                        currSelf.FormData.WordCode = ret.Data.SCRW_GDHM;   //给页面工单号赋值
                                        currSelf.FormData.OrderCode = ret.Data.SCRW_DDHM;   //给页面订单号赋值
                                        currSelf.FormData.TaskCode = ret.Data.SCRW_RWDH;   //给页面工任务单号赋值
                                        currSelf.FormData.SCDH = ret.Data.SCRW_SCDH;        //生产单号
                                        currSelf.FormData.InvName = ret.Data.SCRW_NAME;    //给页面产品名称赋值
                                        currSelf.FormData.ProCode = ret.Data.SCRW_CPBH;    //选中当前的产品编号
                                        currSelf.FormData.OrderNum = ret.Data.SCRW_DDSL;
                                        currSelf.FormData.TaskQty = ret.Data.SCRW_PCSL;
                                        currSelf.FormData.ScrwID = ret.Data.JGMES_PLAN_SCRW_ID;    //生产任务ID
                                        currSelf.FormData.ProductionLineCode = ret.Data.SCRW_CXBM;
                                        currSelf.FormData.OrderCode = ret.Data.SCRW_DDHM;//订单号

                                        //currSelf.JudgeScrwID = ret.Data[0].JGMES_PLAN_SCRW_ID;    //生产任务ID
                                        $.showLoading();
                                        $.ajax({
                                            type: "post",
                                            url: LocalConfig.SrvPath + "/jgmes/commonAction!getGwByCxCode.action",
                                            data: {
                                                "userCode": LocalUserInfo.GetUserInfo().UserCode,
                                                "mac": LocalUserInfo.GetUserInfo().Mac,
                                                "cxCode": currSelf.FormData.ProductionLineCode,
                                            },
                                            dataType: "json",
                                            success: function (ret) {
                                                var retData = ReturnData(ret);
                                                //console.log(retData);
                                                if (retData.IsSuccess) {
                                                    if (retData.Data) {
                                                        currSelf.StationData = retData.Data;
                                                    }
                                                }
                                            },
                                            error: function (xhr, status, errorThrown) {
                                                $.alert("请求失败！" + errorThrown);
                                            },
                                            complete: function () {
                                                $.hideLoading();
                                            }
                                        });

                                        //根据产品获取工序列表接口
                                        $.showLoading();
                                        $.ajax({
                                            type: "post",
                                            url: LocalConfig.SrvPath + "/jgmes/commonAction!getGXListByCpBh.action",
                                            data: {
                                                "userCode": LocalUserInfo.GetUserInfo().UserCode,
                                                "mac": LocalUserInfo.GetUserInfo().Mac,
                                                "cpCode": currSelf.FormData.ProCode,   //产品编号
                                                "zt": "",
                                            },
                                            dataType: "json",
                                            success: function (ret) {
                                                var retData = ReturnData(ret);
                                                //console.log(retData);
                                                if (retData.IsSuccess) {
                                                    if (retData.Data) {
                                                        currSelf.ProcessData = retData.Data;
                                                    } else {
                                                        var meg = "没有相关不良项的工序!";
                                                        $.toptip(meg, "warning");
                                                    }
                                                }
                                            },
                                            error: function (xhr, status, errorThrown) {
                                                $.alert("请求失败！" + errorThrown);
                                            },
                                            complete: function () {
                                                $.hideLoading();
                                            }
                                        });

                                        return false;//返回false，不为空对象
                                    }
                                    return true;//返回true，为空对象
                                }
                            },
                            error: function (xhr, status, errorThrown) {
                                $.alert("搜索相关信息失败!");
                            },
                            complete: function () {
                                $.hideLoading();
                            }
                        });
                    } else {
                        $.toptip("任务单号不能为空", "warning");
                    }
                }
            }
        },
    });
</script>

</html>