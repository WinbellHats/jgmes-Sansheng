<html>

<head>
    <title>关键部件过站(打印)-精工云MES系统移动端</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link href="/JG/Content/jquery/weui/style/weui.min.css" rel="stylesheet" />
    <link href="/JG/Content/jquery/jquery-weui/css/jquery-weui.min.css" rel="stylesheet" />
    <link href="/JG/Content/css/bootstrap.min.css" rel="stylesheet" />
    <link href="/JG/Content/css/Global.css" rel="stylesheet" />
    <link rel="stylesheet" href="/JG/Content/css/ComponentsStation.css">
    <link rel="stylesheet" href="/JG/Content/css/TabletsGlobal.css?v=1">
    <script src="/JG/Content/LocalConfigs.js"></script>
    <script src="/JG/Content/LocalUserInfo.js"></script>
    <style>
        .btn {
            padding: 11px 8px;
            font-size: 1.0em;
        }

        [v-cloak] {
            display: none;
        }
    </style>
</head>

<body ontouchstart>
    <!--title部分-->
    <header class="header">
        <div class="empty">
            <span id="stations"></span>
        </div>
        <div class="header_title">
            <a href="javascript:;">关键部件过站(打印)</a>
        </div>
        <div class="item item2">
            <div class="set">
                <!--<span class="glyphicon glyphicon-cog" style="font-size: 50px;color:#FFFFFF"></span>-->
                <span><img style="width:50px" src="/JG/Content/images/early.png" alt=""></span>
            </div>
            <div class="user_img" onclick="javascript:location.href='/JG/Home/Index.html'">
                <span class="back"><img src="/JG/Content/images/return.png" alt=""></span>
            </div>
            <div class="clean"></div>
        </div>
    </header>

    <div id="MainPage" class="MainPage" v-cloak>
        <div class="col-lg-12" style="text-align:center;font-size:18px;">
            <div class="input-group">
                <label class="input-group-addon" for="BarCode">SN码</label>
                <input type="text" class="form-control" maxlength="50" v-model="BarCode" placeholder="扫描或输入SN码回车"
                    id="BarCode" :disabled="IsDisable" />
                <span class="input-group-btn">
                    <button class="btn btn-success" :disabled="IsDisable" @click="PrintBarCode">关键部件打印</button>
                </span>
            </div>
        </div>
        <div id="tab2" class="weui-tab__bd-item">
            <div class="left">
                <ul class="list-group">
                    <!-- <li class="list-group-item" v-if="CurrProcessName">当前工序&nbsp;&nbsp;{{CurrProcessName}}</li> -->
                    <li class="list-group-item">当前SN码&nbsp;&nbsp;{{CurrBarCode}}
                    </li>
                    <li class="list-group-item">
                        产品SN码&nbsp; &nbsp;{{FormData.InvBarCode}}
                    </li>
                    <li class="list-group-item">
                        任务单号&nbsp;&nbsp;{{FormData.TaskCode}}
                    </li>
                    <!-- <li class="list-group-item">
                        SN码&nbsp; &nbsp;{{FormData.InvBarCode}}
                    </li> -->
                    <!-- <li class="list-group-item">
                        产品编码&nbsp; &nbsp;{{FormData.InvCode}}
                    </li> -->
                    <li class="list-group-item">
                        产品名称&nbsp; &nbsp;{{FormData.InvName}} {{FormData.InvCode}}
                    </li>
                    <li class="list-group-item">
                        产品型号&nbsp; &nbsp;{{FormData.InvStd}}
                    </li>
                    <li class="list-group-item">
                        订单号码/内部订单号&nbsp;&nbsp;{{FormData.OrderCode}}/{{FormData.ProcessCode}}
                    </li>
                    <!-- <li class="list-group-item">
                        流程卡号&nbsp; &nbsp;{{FormData.ProcessCode}}
                    </li> -->
                    <li class="list-group-item">
                        订单数量/任务数量&nbsp;&nbsp;{{FormData.OrderNum}}/{{FormData.TaskQty}}
                    </li>
                    <li class="list-group-item" >
                        <!-- 投入数量&nbsp;&nbsp;{{FormData.InputQty}} -->
                        投入数量/已扫数量&nbsp;&nbsp;{{FormData.InputQty}}/{{ScanCodeNum}}
                    </li>
                    <!-- <li class="list-group-item">
                        已扫数量&nbsp;&nbsp;{{ScanCodeNum}}
                    </li> -->
                </ul>
            </div>

            <div class="right panel panel-default">
                <ul class="nav nav-tabs">
                    <li class="active">
                        <a href="#OperateRecord" data-toggle="tab">操作记录</a>
                    </li>
                    <li>
                        <a href="#Swiper" data-toggle="tab">操作指导</a>
                    </li>
                </ul>
                <div class="tab-content tabs">
                    <div class="tab-pane fade in active" id="OperateRecord">
                        <ul style="height:100%;overflow-y:auto;">
                            <li style="font-size: 1.2em" v-for="(item,index) in OperateRecord"
                                :style="{'color':item.Status?'blue':'red'}">
                                {{item.Content}}
                            </li>
                        </ul>
                    </div>
                    <div class="tab-pane fade" id="Swiper">
                        <div class="swiper-container">
                            <div class="swiper-wrapper" id="Top_Swiper">
                            </div>
                            <div class="swiper-pagination"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!--弹窗部分-->
            <div class="dialog">
                <span><img src="/JG/Content/images/timg.jpg" alt="关闭"></span>
                <div class="dialog_img"><img src="" id="ShowImg" alt=""></div>
            </div>

            <div class="panel panel-default col-md-12 col-lg-12 col-sm-12" style="margin-top: 25px">
                <div class="panel-heading panel-heading1">
                    关键部件
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>序号</th>
                            <th>部件条码</th>
                            <th>部件编码</th>
                            <th>部件名称</th>
                            <!-- <th>数量</th>
                        <th>已绑数量</th> -->
                            <th style="text-align:center">通过状态</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(item,index) in ComponentBindData">
                            <td>{{index+1}}</td>
                            <td>{{item.BarCode}}</td>
                            <td>{{item.InvCode}}</td>
                            <td>{{item.InvName}}/{{item.InvStd}}</td>
                            <td style="text-align:center"><span v-if="item.BindStatus"
                                    style="color:green;font-size: 18px" class="glyphicon glyphicon-ok"></span><span
                                    v-if="item.BindStatus==false" style="color:red;font-size: 18px"
                                    class="glyphicon glyphicon-remove"></span></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="panel panel-default col-md-12 col-lg-12 col-sm-12">
                <div class="panel-heading panel-heading1">
                    过站记录
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>序号</th>
                            <th>SN码</th>
                            <th>产品</th>
                            <th>过站时间</th>
                            <th>操作人</th>
                            <th>过站状态</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(item,index) in StationRecord">
                            <td>{{index+1}}</td>
                            <td>{{item.BarCode}}</td>
                            <td>{{item.InvName}}\{{item.InvStd}}</td>
                            <td>{{item.StationTime}}</td>
                            <td>{{item.Operator}}</td>
                            <td><span
                                    :style="item.PassState=='Pass'?'color:green':'color:red'">{{item.PassState}}</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="/JG/Content/jquery/jquery-3.2.1.min.js"></script>
    <script src="/JG/Content/jquery/jquery-weui/js/jquery-weui.min.js"></script>
    <script src="/JG/Content/Utils.js?v=1"></script>
    <script src="/JG//Content/AudioUtils.js"></script>
    <script src="/JG/Content/Common.js"></script>
    <script src="/JG//Content/Station.js"></script>
    <script src="/JG/Content/bootstrap.min.js"></script>
    <script src="/JG/Content/bootstrap/bootbox/bootbox.min.js"></script>
    <script src="/JG/Content/bootstrap/bootbox/bootbox.locales.min.js"></script>
    <script src="/JG/Content/jquery/jquery-weui/js/swiper.min.js"></script>
    <script src="/JG/Content/jquery/fastclick.js"></script>
    <script src="/JG/Content/bootstrap/bootbox/bootbox.min.js"></script>
    <script src="/JG/Content/bootstrap/bootbox/bootbox.locales.min.js"></script>
    <script>
        $(function () {
            bootbox.setDefaults("locale", "zh_CN");
            FastClick.attach(document.body);

            //安灯弹窗部分动态加载
            Station.Init(".header");
            var stations = LocalUserInfo.GetUserInfo();
            $("#stations").html(stations.ProductionLineName + " - " + stations.StationName);
        });
        //操作指导部分图片弹窗部分
        function popup(e) {
            $("#ShowImg")[0].src = e.src;
            $(".dialog").fadeIn();

            $(".dialog>span").click(function () {
                $(".dialog").fadeOut();
            })
        }
    </script>
    <script src="/JG/Content/vue-v2.34.js"></script>
    <script type="text/javascript">
        var vmPage = new Vue({
            el: "#MainPage",
            data: {
                CurrProcessType: "GXLX004", //当前工序类型
                CurrProcessCode: "",  //当前工序编码
                CurrProcessName: "",  //当前工序名称
                CurrProcessIndex: 0,   //当前工序顺序
                ScanCodeNum: 0,        //扫码数量
                CurrBarCode: "",       //当前条码
                BarCode: "",
                IsDisable: false,
                FormData: {
                    ScheduleID: "", //排产单ID
                    TaskCode: "",   //任务号
                    TaskQty: "", //任务数量
                    InputQty: 0, //投入数量
                    InvCode: "",
                    InvName: "",
                    InvStd: "",
                    InvBarCode: "",
                    InvProcessType: "", //产品工序类型
                    InvSNRule: "", //条码验证规则
                    OrderCode: "",//订单号码
                    OrderNum: "",//订单数量
                    ProcessCode: "",//流程卡号
                },
                ComponentData: [], //部件数据
                ComponentBindData: [],//部件绑定数据
                StationRecord: [],//过站记录
                OperateRecord: [],//操作记录
                MaxOperatingRecordNum: "",//操作记录显示最大条数
            },
            mounted: function () {
                var currSelf = this;
                $("#BarCode").focus();
                $("#BarCode").bind("keypress", currSelf.SearchBarCode);
                Utils.AutoBarCodeFocus();
                var data = MaxOperatingRecord();
                if (data.IsSuccess && data.Data) {
                    currSelf.MaxOperatingRecordNum = data.Data;
                }

                $.showLoading();
                $.ajax({
                    type: "post",
                    url: LocalConfig.SrvPath + "/jgmes/commonAction!getCurrentProductByCxCp.action",
                    data: {
                        userCode: LocalUserInfo.GetUserInfo().UserCode,
                        mac: LocalUserInfo.GetUserInfo().Mac,
                        cxCode: LocalUserInfo.GetUserInfo().ProductionLineCode,
                    },
                    dataType: "json",
                    success: function (ret) {
                        var retData = ReturnData(ret);
                        if (retData.IsSuccess) {
                            currSelf.SetBaseData(retData);
                            //获取当前已扫码数量
                            var NumData = GetCountScan(currSelf.FormData.ScheduleID);
                            //console.log(NumData);
                            if (NumData.IsSuccess && NumData.Data) {
                                currSelf.ScanCodeNum = NumData.Data;
                            }
                        }
                    }, error: function (xhr, status, errorThrown) {
                        console.log(xhr);
                        alert("请求失败");
                    }, complete: function () {
                        $.hideLoading();
                    }
                });
            },
            methods: {
                InitData: function (barCode) {
                    var currSelf = this;
                    $.showLoading();
                    $.ajax({
                        type: "post",
                        url: LocalConfig.SrvPath + "/jgmes/commonAction!getCurrentProductByCxCp.action",
                        data: { userCode: LocalUserInfo.GetUserInfo().UserCode, mac: LocalUserInfo.GetUserInfo().Mac, cxCode: LocalUserInfo.GetUserInfo().ProductionLineCode },
                        dataType: "json",
                        success: function (ret) {
                            var retData = ReturnData(ret);
                            if (retData.IsSuccess) {
                                currSelf.SetBaseData(retData);

                            }
                        }, error: function (xhr, status, errorThrown) {
                            console.log(xhr);
                            alert("请求失败");
                        }, complete: function () {
                            $.hideLoading();
                        }
                    });
                },
                SetOperateRecord: function (content, status) {
                    var currSelf = this;
                    var content = (new Date().Format("hh:mm:sss")) + ' ' + content;
                    currSelf.OperateRecord.splice(0, 0, { Content: content, Status: status });
                    if (currSelf.OperateRecord.length > currSelf.MaxOperatingRecordNum) {
                        currSelf.OperateRecord.splice(currSelf.MaxOperatingRecordNum)
                    }
                },
                SetInputQuantity: function (err, data) {
                    var currSelf = this;
                    if (!err && data && data.IsSuccess) {
                        currSelf.FormData.InputQty = data.Data;
                    }
                },
                SetBaseData: function (retData) {
                    var currSelf = this;

                    currSelf.FormData.ScheduleID = retData.Data.JGMES_PLAN_SCRW_ID;
                    currSelf.FormData.TaskCode = retData.Data.SCRW_RWDH;
                    currSelf.FormData.InvCode = retData.Data.SCRW_CPBH;
                    currSelf.FormData.InvName = retData.Data.SCRW_NAME;
                    currSelf.FormData.InvStd = retData.Data.SCRW_CPGG;
                    currSelf.FormData.LineCode = retData.Data.SCRW_CXBM;
                    // currSelf.FormData.LineCode = retData.Data.SCRW_CXMC;
                    currSelf.FormData.TaskQty = retData.Data.SCRW_PCSL;
                    currSelf.FormData.OrderCode = retData.Data.SCRW_DDHM;
                    currSelf.FormData.OrderNum = retData.Data.SCRW_DDSL;
                    currSelf.FormData.ProcessCode = retData.Data.SCRW_LCKH;

                    if (retData.Data.Detail) {
                        currSelf.FormData.InvSNRule = retData.Data.Detail.PRODUCTDATA_TMYZGZ;
                    }
                    //获取当前用户当前产品的工序
                    var data = GetCurrentProcess(currSelf.FormData.InvCode);
                    // //获取当前已扫码数量
                    // var NumData = GetCountScan(currSelf.FormData.ScheduleID);
                    // //console.log(NumData);
                    // if (NumData.IsSuccess && NumData.Data) {
                    //     currSelf.ScanCodeNum = NumData.Data;
                    // }

                    if (data.IsSuccess && data.Data) {
                        currSelf.FormData.InvProcessType = data.Data.GXGL_GXLX_NAME;
                        currSelf.CurrProcessCode = data.Data.GXGL_GXNUM;
                        currSelf.CurrProcessName = data.Data.GXGL_GXNAME;

                        currSelf.CurrProcessIndex = data.Data.GXGL_GXSXH;  //首工位为1,大于1显示投入数量
                        if (Utils.TabletsGlobalParam.IsOpenInputQtyTask) {
                            GetInputQuantity(currSelf.FormData.InvCode, currSelf.FormData.ScheduleID, currSelf.SetInputQuantity);

                            var ret1 = setInterval(function () {
                                GetInputQuantity(currSelf.FormData.InvCode, currSelf.FormData.ScheduleID, currSelf.SetInputQuantity);
                            }, Utils.TabletsGlobalParam.InputQtyTaskFrequency);
                        }

                        if (data.Data.GXGL_SOP && data.Data.GXGL_SOP.length > 0) {
                            var htmlAppend = "";
                            var imgSOPs = JSON.parse(data.Data.GXGL_SOP);
                            for (var index in imgSOPs) {
                                var item = imgSOPs[index];
                                htmlAppend += "<div class='swiper-slide'><img onclick='popup(this)' style='width:100%;height:100%' src='" + LocalConfig.SrvPath + item.path + "'/></div>";
                            }
                            $("#Top_Swiper").append(htmlAppend);
                            //3.11 自动轮播
                            var index = 0;
                            /*当鼠标放到顺序按钮上时：
                            1.将当前这个顺序按钮增加样式为红色背景
                            2.移除周围其他同级元素红色背景样式
                            3.获取当前顺序按钮的index
                            4.通过index获取该位置图片
                            5.一秒钟渐入该图片
                            6.一秒钟渐出其他相邻图片
                            7.防止移动过快导致的效果闪现，使用stop方法
                            */
                            $("#Swiper div>span").mousemove(function () {
                                $(this).addClass("swiper-pagination-bullet-active").siblings().removeClass("swiper-pagination-bullet-active");
                                index = $(this).index();
                                $("#Top_Swiper div").eq(index).stop().fadeIn(1000).siblings().stop().fadeOut(0);
                            });
                            var len = $('#Top_Swiper div').length;
                            var time = setInterval(move, 3000);

                            function move() {
                                index++;
                                if (index == len) {
                                    index = 0;
                                }
                                $('#Swiper div>span').eq(index).addClass("swiper-pagination-bullet-active").siblings().removeClass("swiper-pagination-bullet-active");
                                $('#Top_Swiper div').eq(index).stop().fadeIn(1000).siblings().stop().fadeOut(0);
                            }

                            /*当鼠标划入、划出轮播图区域时：
                            1.划入时停止自动轮播
                            2.划出时继续自动轮播
                            */
                            $("#Swiper").hover(function () {
                                clearInterval(time);
                            },
                                function () {
                                    time = setInterval(move, 3000);
                                });
                            if (imgSOPs && imgSOPs.length > 1) {
                                $(".swiper-container").swiper({
                                    loop: true,
                                    autoplay: 3000
                                });
                            }
                        }
                    }
                    if (currSelf.FormData.InvCode) {
                        $.ajax({
                            type: "post",
                            async: false,
                            url: LocalConfig.SrvPath + "/jgmes/commonAction!getGXWLXMList.action",
                            data: { userCode: LocalUserInfo.GetUserInfo().UserCode, mac: LocalUserInfo.GetUserInfo().Mac, cpCode: currSelf.FormData.InvCode },
                            dataType: "json",
                            success: function (ret) {
                                var retData = ReturnData(ret);
                                if (retData.IsSuccess && retData.Data) {
                                    for (var i in retData.Data) {
                                        var element = retData.Data[i];
                                        currSelf.ComponentData.push({
                                            InvCode: element.GXWL_WLBH, InvName: element.GXWL_WLMC,
                                            InvBarCode: element.GXWL_TM, InvStd: element.GXWL_WLGG, Num: element.GXWL_SL, BindNum: 0,
                                            InvSNRule: element.Detail.PRODUCTDATA_TMYZGZ,
                                            BindStatus: false
                                        });
                                    }
                                    currSelf.ComponentBindData = JSON.parse(JSON.stringify(currSelf.ComponentData));
                                } else {
                                    var showMsg = "未能找到当前工序的关键部件";
                                    $.toptip(showMsg, Utils.ToptipWaitTime.Warning, "warning");
                                    currSelf.SetOperateRecord(showMsg, false);
                                }
                            }, error: function (xhr, status, errorThrown) {
                                console.log(xhr);
                                $.alert("发生异常");
                            }, complete: function () {
                            }
                        });
                    }
                },
                PrintBarCode: function () {
                    var currSelf = this;
                    var showMsg = "";
                    if (currSelf.FormData.InvBarCode.length > 0) {

                        currSelf.IsDisable = true;
                        bootbox.prompt("请输入关键部件条码", function (result) {
                            if (result) {
                                currSelf.CurrBarCode = result;
                                $.showLoading();
                                $.ajax({
                                    type: "post",
                                    url: LocalConfig.SrvPath + "/jgmes/commonAction!getPrintInfo.action",
                                    data: {
                                        userCode: LocalUserInfo.GetUserInfo().UserCode, mac: LocalUserInfo.GetUserInfo().Mac,
                                        cpCode: currSelf.FormData.InvCode, printQty: 1, barCodes: currSelf.CurrBarCode
                                    },
                                    dataType: "json",
                                    success: function (ret) {
                                        var printInfo = ReturnData(ret);
                                        if (printInfo.IsSuccess && printInfo.Data) {
                                            if (!printInfo.Data.Address || !printInfo.Data.PrintParams) {
                                                showMsg = "打印参数信息缺失";
                                                currSelf.SetOperateRecord(showMsg, false);
                                                $.toptip(showMsg, Utils.ToptipWaitTime.Error, "error");
                                                return;
                                            }
                                            currSelf.SetOperateRecord("成功获取打印参数信息!", true);
                                            AudioUtils.Play(AudioUtils.StartPrint);
                                            $.ajax({
                                                type: "post",
                                                url: printInfo.Data.Address,
                                                async: false,
                                                data: printInfo.Data.PrintParams,
                                                dataType: "json",
                                                success: function (ret) {
                                                    if (ret.IsSuccess) {
                                                        currSelf.SetOperateRecord(currSelf.CurrBarCode + ",打印成功!", true);
                                                        AudioUtils.Play(AudioUtils.PrintSuccess);
                                                        var record = { BarCode: currSelf.FormData.InvBarCode, InvName: currSelf.FormData.InvName, InvStd: currSelf.FormData.InvStd, StationTime: new Date().Format("hh:mm:ss"), Operator: LocalUserInfo.GetUserInfo().UserName, PassState: "Pass" };
                                                        var jsonStrDetail = [];
                                                        for (var i in currSelf.ComponentBindData) {
                                                            var element = currSelf.ComponentBindData[i];
                                                            element.BarCode = currSelf.CurrBarCode;
                                                            element.BindStatus = true;
                                                            jsonStrDetail.push({ "BGSJZB_WLBH": element.InvCode, "BGSJZB_WLMC": element.InvName, "BGSJZB_WLGG": element.InvStd, "BGSJZB_SL": element.BindNum, "BGSJZB_TMH": element.BarCode, "BGSJZB_SL": element.Qty });
                                                        }

                                                        $.ajax({
                                                            type: "post",
                                                            async: false,
                                                            url: LocalConfig.SrvPath + "/jgmes/commonAction!doJsonSaveBGSJAll.action",
                                                            data: { "userCode": LocalUserInfo.GetUserInfo().UserCode, "mac": LocalUserInfo.GetUserInfo().Mac, "jsonStr": JSON.stringify({ "BGSJ_TMH": currSelf.FormData.InvBarCode, "BGSJ_CPBH": currSelf.FormData.InvCode, "BGSJ_SL": 1, "BGSJ_SCRWID": currSelf.FormData.ScheduleID, "BGSJ_PDJG_CODE": "PDJG01" }), "jsonStrDetail": JSON.stringify(jsonStrDetail) },
                                                            dataType: "json",
                                                            success: function (ret) {
                                                                var retData = ReturnData(ret);
                                                                if (retData.IsSuccess) {
                                                                    currSelf.ScanCodeNum++;
                                                                    $.toptip(currSelf.FormData.InvBarCode + ',报工成功', Utils.ToptipWaitTime.Success, 'success');
                                                                    currSelf.SetOperateRecord(currSelf.FormData.InvBarCode + ",报工成功!", true);
                                                                } else {
                                                                    currSelf.PassState = retData.message;
                                                                    currSelf.SetOperateRecord(currSelf.FormData.InvBarCode + ",报工失败!" + retData.message, false);
                                                                }
                                                            }, error: function (XMLHttpRequest, textStatus, errorThrown) {
                                                                console.error("报工异常:%s", textStatus);
                                                                $.alert("报工过程中发生异常!");
                                                            }
                                                        });
                                                        currSelf.FormData.InvBarCode = "";
                                                        currSelf.StationRecord.splice(0, 0, record);
                                                    } else {
                                                        AudioUtils.Play(AudioUtils.PrintFail);
                                                        currSelf.SetOperateRecord(currSelf.CurrBarCode + ",打印失败!", false);
                                                    }
                                                }, error: function (xhr, status, err) {
                                                    console.error("打印失败%s", status);
                                                    $.alert("打印失败!");
                                                }
                                            });
                                        } else {
                                            currSelf.SetOperateRecord("获取打印参数失败,原因:" + printInfo.message, false);
                                        }
                                    }, error: function (xhr, status, err) {
                                        console.error(status);
                                        $.alert("请求失败");
                                    }, complete: function () {
                                        $.hideLoading();
                                    }
                                });
                            }
                        });
                        currSelf.IsDisable = false;
                    } else {
                        showMsg = "请扫产品SN码";
                        $.toptip(showMsg, Utils.ToptipWaitTime.Warning, "warning");
                        currSelf.SetOperateRecord(showMsg, false);
                        $("#barCode").focus();
                    }
                },
                SearchBarCode: function (event) {
                    var currSelf = this;
                    if (event.which == 13) {
                        var barCode = currSelf.BarCode;
                        currSelf.BarCode = "";
                        var showMsg;
                        currSelf.IsDisable = true;
                        if (!currSelf.FormData.InvCode) {
                            showMsg = '当前产线无产品在生产中';
                            $.toptip(showMsg, Utils.ToptipWaitTime.Warning, "warning");
                            currSelf.SetOperateRecord(showMsg, false);
                            AudioUtils.Play(AudioUtils.ScanCodeFail);
                        } else if (currSelf.CurrProcessType != currSelf.FormData.InvProcessType) {
                            showMsg = '工序类型不匹配不能过站,请核对!';
                            $.toptip(showMsg, Utils.ToptipWaitTime.Warning, "warning");
                            currSelf.SetOperateRecord(showMsg, false);
                            AudioUtils.Play(AudioUtils.ScanCodeFail);
                        } else if (!barCode || barCode.length <= 0) {
                            showMsg = 'SN码不能为空';
                            $.toptip(showMsg, Utils.ToptipWaitTime.Warning, "warning");
                            currSelf.SetOperateRecord(showMsg, false);
                            AudioUtils.Play(AudioUtils.ScanCodeFail);
                        } else {
                            currSelf.CurrBarCode = barCode;  //保存已输入的条码
                            if (Utils.IsTest(currSelf.FormData.InvSNRule, currSelf.CurrBarCode)) {
                                currSelf.ComponentBindData = JSON.parse(JSON.stringify(currSelf.ComponentData));

                                var IsCheckBarCode = CheckProductBarCode(currSelf.FormData.InvCode, currSelf.CurrBarCode, currSelf.FormData.ScheduleID);//校验或换产
                                if (IsCheckBarCode.IsSuccess) {
                                    AudioUtils.Play(AudioUtils.ScanCodeSuccess);
                                    currSelf.FormData.InvBarCode = currSelf.CurrBarCode;
                                    $.toptip("扫码成功", Utils.ToptipWaitTime.Success, "success");
                                    currSelf.SetOperateRecord(currSelf.CurrBarCode + ",扫码成功!", true);

                                } else {
                                    AudioUtils.Play(AudioUtils.ScanCodeFail);
                                    showMsg = currSelf.CurrBarCode + ",扫码失败！失败原因:" + IsCheckBarCode.message;
                                    currSelf.SetOperateRecord(showMsg, false);
                                    $.toptip(showMsg, Utils.ToptipWaitTime.Error, "error");
                                    // if (IsCheckBarCode.ErroCode == 10199) {
                                    //     currSelf.SetOperateRecord("生产线已经更换产品{" + currSelf.FormData.InvName + "},请重新扫码", false);
                                    //     currSelf.SetBaseData(IsCheckBarCode.Data);
                                    // }
                                    if (IsCheckBarCode.ErrorCode == 10199) { //换产
                                        currSelf.SetOperateRecord("生产线任务单{" + currSelf.FormData.TaskCode + "}已经更换,请重新扫码", false);
                                        currSelf.InitData(barCode);
                                        // bootbox.confirm({
                                        //     message: "是否进行换产？", buttons: {
                                        //         confirm: {
                                        //             label: '是',
                                        //             className: 'btn-success'
                                        //         },
                                        //         cancel: {
                                        //             label: '否',
                                        //             className: 'btn-danger'
                                        //         }
                                        //     }, callback: function (result) {
                                        //         if (result) {

                                        //             currSelf.InitData(barCode);
                                        //         }
                                        //     }
                                        // });

                                    }

                                }
                            } else if (currSelf.FormData.InvBarCode.length > 0) {

                                // var IsExists = false;
                                // var IsBind = false;
                                // var FinishNum = 0;
                                // for (var i in currSelf.ComponentBindData) {
                                //     var item = currSelf.ComponentBindData[i];
                                //     if (item.BindStatus == false && IsBind == false) {
                                //         var IsSuccessful = false;

                                //         if ((item.InvSNRule && Utils.IsTest(item.InvSNRule, currSelf.CurrBarCode)))
                                //             IsSuccessful = true;
                                //         else if (item.InvSNRule && item.InvSNRule.indexOf("SSNProcess") >= 0) {
                                //             var func = "currSelf." + item.InvSNRule + "()";
                                //             var f = eval(func);
                                //             IsSuccessful = f ? true : false;
                                //         }

                                //         if (!IsSuccessful && item.InvBarCode == currSelf.CurrBarCode)
                                //             //else if (item.InvBarCode == currSelf.CurrBarCode)
                                //             IsSuccessful = true;
                                //         if (IsSuccessful) {
                                //             IsExists = true;
                                //             item.BarCode = currSelf.CurrBarCode;
                                //             item.Qty = 1;
                                //             item.BindStatus = true;
                                //             FinishNum++;
                                //             showMsg = item.InvName + "(" + currSelf.CurrBarCode + "),绑定成功";
                                //             $.toptip(showMsg, Utils.ToptipWaitTime.Success, "success");
                                //             AudioUtils.Play(AudioUtils.ScanCodeSuccess);
                                //             currSelf.SetOperateRecord(showMsg, true);
                                //             IsBind = true;
                                //         }

                                //     } else if (item.BindStatus)
                                //         FinishNum++;
                                // }
                                // if (IsExists == false) {
                                //     showMsg = currSelf.CurrBarCode + ",产品部件不匹配";
                                //     currSelf.SetOperateRecord(showMsg, false);
                                //     $.toptip(showMsg, Utils.ToptipWaitTime.Error, 'error');
                                //     AudioUtils.Play(AudioUtils.ScanCodeFail);
                                // } else if (currSelf.ComponentBindData.length == FinishNum) {

                                //     $.showLoading();
                                //     var jsonStr = JSON.stringify({ "BGSJ_TMH": currSelf.FormData.InvBarCode, "BGSJ_CPBH": currSelf.FormData.InvCode, "BGSJ_SL": 1, "BGSJ_SCRWID": currSelf.FormData.ScheduleID, "BGSJ_PDJG_CODE": "PDJG01" });
                                //     var jsonStrDetail = [];

                                //     for (var i in currSelf.ComponentBindData) {
                                //         var element = currSelf.ComponentBindData[i];
                                //         jsonStrDetail.push({ "BGSJZB_WLBH": element.InvCode, "BGSJZB_WLMC": element.InvName, "BGSJZB_WLGG": element.InvStd, "BGSJZB_SL": element.BindNum, "BGSJZB_TMH": element.BarCode, "BGSJZB_SL": element.Qty });
                                //     }
                                //     // currSelf.ComponentBindData.forEach(element => {
                                //     //     jsonStrDetail.push({ "BGSJZB_WLBH": element.InvCode, "BGSJZB_WLMC": element.InvName, "BGSJZB_WLGG": element.InvStd, "BGSJZB_SL": element.BindNum, "BGSJ_TMH": element.BarCode });
                                //     // });

                                //     var record = { BarCode: currSelf.FormData.InvBarCode, InvName: currSelf.FormData.InvName, InvStd: currSelf.FormData.InvStd, StationTime: (new Date()).toLocaleTimeString(), Operator: LocalUserInfo.GetUserInfo().UserName, PassState: "Pass" };

                                //     $.ajax({
                                //         type: "post",
                                //         url: LocalConfig.SrvPath + "/jgmes/commonAction!doJsonSaveBGSJAll.action",
                                //         data: {
                                //             "userCode": LocalUserInfo.GetUserInfo().UserCode,
                                //             "mac": LocalUserInfo.GetUserInfo().Mac,
                                //             "jsonStr": jsonStr,
                                //             "jsonStrDetail": JSON.stringify(jsonStrDetail)
                                //         },
                                //         dataType: "json",
                                //         success: function (ret) {
                                //             var retData = ReturnData(ret);

                                //             if (retData.IsSuccess) {
                                //                 currSelf.ScanCodeNum++;
                                //                 showMsg = currSelf.FormData.InvBarCode + ",过站成功!";
                                //                 currSelf.SetOperateRecord(showMsg, true);
                                //                 $.toptip(showMsg, Utils.ToptipWaitTime.Success, 'success');
                                //                 AudioUtils.Play(AudioUtils.OutStationSuccess);
                                //             } else {
                                //                 showMsg = currSelf.FormData.InvBarCode + ",过站失败！失败原因:" + retData.message;
                                //                 record.PassState = retData.message;
                                //                 currSelf.SetOperateRecord(showMsg, false);
                                //                 AudioUtils.Play(AudioUtils.OutStationFail);
                                //             }
                                //             currSelf.FormData.InvBarCode = "";
                                //             currSelf.StationRecord.splice(0, 0, record);
                                //         }, error: function (xhr, status, errorThrown) {
                                //             console.error(status);
                                //             $.alert("提交失败");
                                //         }, complete: function () {
                                //             $.hideLoading();
                                //         }
                                //     });
                                // }
                            } else {
                                showMsg = barCode + ',请先扫产品SN码,再扫部件码';
                                $.toptip(showMsg, Utils.ToptipWaitTime.Warning, "warning");
                                currSelf.SetOperateRecord(showMsg, false);
                                AudioUtils.Play(AudioUtils.ScanCodeFail);
                            }
                        }
                        currSelf.IsDisable = false;
                    }
                },

                SSNProcess: function () { //SSN码校验
                    var currSelf = this;
                    //0004VG-0001001AJ
                    var SNNCode = currSelf.CurrBarCode.substring(7, 14);
                    debugger;
                    if (currSelf.FormData.InvBarCode.indexOf(SNNCode) >= 0)
                        return true;
                    else return false;
                }
            }
        });
    </script>
</body>

</html>